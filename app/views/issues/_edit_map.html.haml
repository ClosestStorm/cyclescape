:javascript
  var format = new OpenLayers.Format.GeoJSON({internalProjection: new OpenLayers.Projection("EPSG:900913"), externalProjection : new OpenLayers.Projection("EPSG:4326")});

  function serialize(feature) {
    var str = format.write(feature);
    document.getElementById('issue_loc_json').value = str;
  }

  function feature_added(event) {
    toolbar.deactivate();
    modify.activate();
    clearpanel.activate();
    serialize(event.feature);
  }

  function feature_modified(event) {
    serialize(event.feature);
  }

  function clear_features(event) {
    clearpanel.deactivate();
    modify.deactivate();
    document.getElementById('issue_loc_json').value = "";
    vectorlayer.removeAllFeatures();
    toolbar.activate();
  }

:ruby
  @map = basic_map do |map, page|
    page << map.setCenter(OpenLayers::LonLat.new(@start_location.x, @start_location.y).transform(projection, map.getProjectionObject()),@start_location.z);

    vectorlayer = MapLayers::JsVar.new("vectorlayer")
    page.assign(vectorlayer, OpenLayers::Layer::Vector.new("Vectors", projection: projection))
    page << map.add_layer(vectorlayer)
    toolbar = MapLayers::JsVar.new("toolbar")
    page.assign(toolbar, OpenLayers::Control::EditingToolbar.new(vectorlayer))
    page << map.addControl(toolbar)
    modify = MapLayers::JsVar.new("modify")
    page.assign(modify, OpenLayers::Control::ModifyFeature.new(vectorlayer))
    page << map.addControl(modify)

    clearpanel = MapLayers::JsVar.new("clearpanel")
    clearbutton = MapLayers::JsVar.new("clearbutton")
    page.assign(clearpanel, OpenLayers::Control::Panel.new({displayClass: "olControlEditingToolbar"}))
    page.assign(clearbutton, OpenLayers::Control::Button.new({title: "Clear", displayClass: "clearButton", trigger: :clear_features}))
    page << clearpanel.addControls([clearbutton])
    page << map.addControl(clearpanel)
    page << clearpanel.deactivate()
  end

%div#map{ style: "height: 300px; width: 100%; border:1px solid black; margin-top: 3em" }
!= @map.to_html
:javascript
  vectorlayer.events.on({featureadded: feature_added});
  vectorlayer.events.on({featuremodified: feature_modified});
  if ( document.getElementById('issue_loc_json').value != '' ) {
    vectorlayer.addFeatures( format.read(document.getElementById('issue_loc_json').value));
    map.zoomToExtent(vectorlayer.features[0].geometry.bounds);
  }
