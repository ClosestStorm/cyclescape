%article.issue
  %header
    %h2= @issue.title
  .main
    %section.details
      %ul
        %li= t ".added_by_html", name: link_to_profile(@issue.created_by), time: l(@issue.created_at.to_date)
        %li= t ".category_html", category: @issue.category.name
    %section.description
      = @issue.description
  .additional
    %section.map
      = render partial: "map", locals: { issue: @issue }
  %section.threads
    - @threads.each do |thread|
      %article.thread
        .wrapper
          %header
            %h3= link_to_if (permitted_to? :view, thread), thread.title, thread_path(thread)
            %span.privacy= thread_type(thread) + ", "
            %span.count= pluralize(thread.messages.count, "message") + ", "
            %span.participants= pluralize(thread.participants.count, "participant")
          %section.messages
            - thread.messages.recent.each do |message|
              %article.message
                == "#{message_truncate message}"

    %ul.horizontal
      - if permitted_to? :create, :message_threads
        %li= link_to t(".new_public_thread"), new_issue_thread_path(@issue), class: "button"
      - user_groups.each do |group|
        %li= link_to t(".new_group_thread", group: group.name), new_issue_thread_path(@issue, group_id: group), class: "button"
